generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Tenant {
  id              String                  @id @default(uuid())
  name            String
  slug            String                  @unique
  createdAt       DateTime                @default(now())
  updatedAt       DateTime                @updatedAt
  rooms           Int?
  appointments    Appointment[]
  openingHours    EstablishmentSchedule[]
  availableSlots  EstablishmentSlot[]
  notifications   Notification[]
  paymentProofs   PaymentProof[]
  portfolioImages PortfolioImage[]
  professionals   Professional[]
  schedules       ProfessionalSchedule[]
  recurrenceRules RecurrenceRule[]
  reviews         Review[]
  services        Service[]
  config          TenantConfig?
  users           User[]
}

model PortfolioImage {
  id        String   @id @default(uuid())
  url       String
  title     String?
  isActive  Boolean  @default(true)
  tenantId  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  isPublic  Boolean  @default(true)
  tenant    Tenant   @relation(fields: [tenantId], references: [id])
}

model EstablishmentSchedule {
  id        String  @id @default(uuid())
  dayOfWeek Int
  startTime String
  endTime   String
  isActive  Boolean @default(true)
  tenantId  String
  tenant    Tenant  @relation(fields: [tenantId], references: [id])

  @@unique([tenantId, dayOfWeek])
}

model EstablishmentSlot {
  id       String  @id @default(uuid())
  time     String
  isActive Boolean @default(true)
  tenantId String
  tenant   Tenant  @relation(fields: [tenantId], references: [id])

  @@unique([tenantId, time])
}

model User {
  id            String         @id @default(uuid())
  email         String         @unique
  password      String
  name          String
  role          Role           @default(USER)
  tenantId      String
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  appointments  Appointment[]
  notifications Notification[]
  reviews       Review[]
  tenant        Tenant         @relation(fields: [tenantId], references: [id])
}

model Service {
  id           String        @id @default(uuid())
  name         String
  description  String?
  price        Decimal
  duration     Int
  tenantId     String
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  category     String?
  appointments Appointment[]
  reviews      Review[]
  tenant       Tenant        @relation(fields: [tenantId], references: [id])
}

model Professional {
  id              String                 @id @default(uuid())
  name            String
  tenantId        String
  profileImageUrl String?
  averageRating   Float?                 @default(0)
  commissionRate  Decimal                @default(0.0)
  createdAt       DateTime               @default(now())
  updatedAt       DateTime               @updatedAt
  role            String?
  services        String[]               @default([])
  appointments    Appointment[]
  tenant          Tenant                 @relation(fields: [tenantId], references: [id])
  schedules       ProfessionalSchedule[]
  reviews         Review[]
}

model Appointment {
  id               String            @id @default(uuid())
  date             DateTime
  status           AppointmentStatus @default(SCHEDULED)
  tenantId         String
  serviceId        String
  professionalId   String?
  userId           String?
  paymentStatus    PaymentStatus     @default(PENDING_PROOF_UPLOAD)
  recurrenceRuleId String?
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  professional     Professional?     @relation(fields: [professionalId], references: [id])
  recurrenceRule   RecurrenceRule?   @relation(fields: [recurrenceRuleId], references: [id])
  service          Service           @relation(fields: [serviceId], references: [id])
  tenant           Tenant            @relation(fields: [tenantId], references: [id])
  user             User?             @relation(fields: [userId], references: [id])
  paymentProof     PaymentProof?
  review           Review?

  @@index([tenantId, date])
  @@index([professionalId, date])
  @@index([userId])
  @@index([recurrenceRuleId])
}

model PaymentProof {
  id            String      @id @default(uuid())
  url           String
  uploadedAt    DateTime    @default(now())
  appointmentId String      @unique
  tenantId      String
  appointment   Appointment @relation(fields: [appointmentId], references: [id])
  tenant        Tenant      @relation(fields: [tenantId], references: [id])
}

model Review {
  id             String       @id @default(uuid())
  rating         Int
  comment        String?
  appointmentId  String       @unique
  serviceId      String
  professionalId String
  userId         String?
  tenantId       String
  createdAt      DateTime     @default(now())
  appointment    Appointment  @relation(fields: [appointmentId], references: [id])
  professional   Professional @relation(fields: [professionalId], references: [id])
  service        Service      @relation(fields: [serviceId], references: [id])
  tenant         Tenant       @relation(fields: [tenantId], references: [id])
  user           User?        @relation(fields: [userId], references: [id])

  @@index([professionalId])
}

model Notification {
  id        String   @id @default(uuid())
  userId    String?
  message   String
  type      String
  isRead    Boolean  @default(false)
  tenantId  String
  metadata  Json?
  createdAt DateTime @default(now())
  title     String?
  tenant    Tenant   @relation(fields: [tenantId], references: [id])
  user      User?    @relation(fields: [userId], references: [id])

  @@index([userId, isRead])
}

model RecurrenceRule {
  id           String        @id @default(uuid())
  frequency    String
  interval     Int           @default(1)
  count        Int?
  endDate      DateTime?
  dayOfWeek    Int?
  tenantId     String
  createdAt    DateTime      @default(now())
  appointments Appointment[]
  tenant       Tenant        @relation(fields: [tenantId], references: [id])
}

model TenantConfig {
  id               String  @id @default(uuid())
  tenantId         String  @unique
  publicName       String?
  themeColor       String? @default("#3B82F6")
  logoUrl          String?
  pixKey           String?
  agentName        String? @default("Assistente FlowMaster")
  agentGreeting    String? @default("Ol√°! Sou o assistente virtual. Como posso ajudar?")
  agentPersonality String?
  agentTone        String? @default("friendly")
  tenant           Tenant  @relation(fields: [tenantId], references: [id])
}

model ProfessionalSchedule {
  id             String       @id @default(uuid())
  professionalId String
  dayOfWeek      Int
  startTime      String
  endTime        String
  tenantId       String
  professional   Professional @relation(fields: [professionalId], references: [id])
  tenant         Tenant       @relation(fields: [tenantId], references: [id])

  @@unique([professionalId, dayOfWeek])
}

enum Role {
  USER
  ADMIN
  SUPERADMIN
  EMPLOYEE
}

enum AppointmentStatus {
  SCHEDULED
  COMPLETED
  CANCELLED
  CONFIRMED
}

enum PaymentStatus {
  PENDING_PROOF_UPLOAD
  PENDING_APPROVAL
  PAID
  REJECTED
}
